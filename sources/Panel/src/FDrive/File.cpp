#include "stdafx.h"
#ifndef WIN32
#include "defines.h"
#include "log.h"
#include "File.h"
#include "Command.h"
#include "Interface/InterfacePanel.h"
#include "Utils/String.h"
#include <cstring>
#endif


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
static struct Picture
{
    uint8 data[300];
    void Clear()
    {
        std::memset(data, 0, 300);
    }
} picture;


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Порядковый номер файла в текущей папке
static int num = -1;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
File::File()
{
    picture.Clear();
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File::~File()
{
    Close();
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void File::Draw(int /*x*/, int /*y*/)
{
    if (num == -1)
    {
        return;
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool File::Handler(Message * /*msg*/)
{
    return true;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
static bool EqualsRequestPicture(Task *request, Task *answer)
{
    Message *send = request->GetMessage();
    Message *recv = answer->GetMessage();

    uint8 com = Command::FDrive_GetPictureDDS;

    return  (com == send->TakeByte()) &&
            (com == recv->TakeByte()) &&
            (send->TakeByte() == recv->TakeByte());
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void File::Open(int _num)
{
    Close();

    Message *message = new Message(Command::FDrive_GetPictureDDS, (uint8)_num);

    Task *task = new Task(message, File::Handler, EqualsRequestPicture);

    Interface::AddTask(task);
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void File::Close()
{
    num = -1;

    picture.Clear();
}
