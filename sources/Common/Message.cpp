#include "stdafx.h"
#ifndef WIN32
#include "defines.h"
#include "log.h"
#include "structs.h"
#include "Message.h"
#include "Hardware/CPU.h"
#include <cstring>
#include <cstdlib>
#endif


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Message::Message() : allocated(0), buffer(0), used(0), taken(0)
{

}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Message::~Message()
{
    FreeMemory();
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool Message::CreateAllocate(uint8 *_buffer, uint _size)
{
    if (AllocateMemory(_size))
    {
        std::memcpy(buffer, _buffer, _size);
        used = _size;
    }

    return buffer != 0;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool Message::CreateFromMessage(Message *message)
{
    if (AllocateMemory(message->Size()))
    {
        std::memcpy(buffer, message->Data(), message->Size());
        used = message->Size();
    }

    return buffer != 0;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void Message::Put8(uint8 data)
{
    if (used < allocated)
    {
        buffer[used] = data;
        used += sizeof(data);
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void Message::Put32(uint data)
{
    if (used < allocated)
    {
        BitSet32 bs(data);
        bs.WriteToBuffer(buffer + used);
        used += sizeof(data);
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
uint8 Message::TakeByte()
{
    uint8 result = 0xff;

    if (taken < used)
    {
        result = buffer[taken];
        taken += sizeof(result);
    }

    return result;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
uint Message::TakeWord()
{
    uint result = 0xffffffff;

    if (taken < used)
    {
        BitSet32 bs(buffer + taken);
        result = bs.word;
        taken += sizeof(result);
    }

    return result;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
uint64 Message::TakeDoubleWord()
{
    uint64 result = 0xffffffffffffffff;

    if (taken < used)
    {
        BitSet64 bs(buffer + taken);
        result = bs.dword;
        taken += sizeof(result);
    }

    return result;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
float Message::TakeFloat()
{
    float result = -1.0f;

    if (taken < used)
    {
        BitSet32 bs(buffer + taken);
        result = bs.floatValue;
        taken += sizeof(result);
    }

    return result;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool Message::AllocateMemory(uint size)
{
    FreeMemory();

    if (size == 0)
    {
        return false;
    }

    buffer = (uint8 *)std::malloc(size);
    if (buffer)
    {
        allocated = size;
    }
    else
    {
        LOG_WRITE("Не могу выделить %d байт", size);
    }

    return buffer != 0;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void Message::FreeMemory()
{
    allocated = 0;
    used = 0;
    std::free(buffer);
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
uint8 *Message::Data()
{
    return buffer;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
uint Message::Size() const
{
    return allocated;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool Message::IsEmpty() const
{
    return buffer != 0;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bool Message::IsEquals(const Message *message) const
{
    if (Size() != message->Size())
    {
        return false;
    }

    return std::memcmp(((Message *)message)->Data(), ((Message *)this)->Data(), Size()) == 0;
}
