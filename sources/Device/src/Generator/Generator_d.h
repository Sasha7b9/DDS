#pragma once
#include "AD9952.h"
#include "AD5697.h"
#include "FPGA.h"
#include "common/Command.h"


class DGenerator
{
public:
    static const int DDS_NUM_POINTS = 8 * 1024;

    static void Init();

    static void EnableChannel(Chan::E ch, bool enable);

    static void SetFormWave(Chan::E ch, TypeForm::E form);

    static void SetOffset(Chan::E ch, Value offset);

    static void SetFrequency(Chan::E ch, Value frequency);

    static void SetAmplitude(Chan::E ch, Value amplitude);

    static void SetDuration(Chan::E ch, Value duration);

    static void SetDutyRatio(Chan::E ch, Value dutyRatio);

    static void SetPhase(Chan::E ch, Value phase);

    static void SetDelay(Chan::E ch, Value duration);

    static void SetManipulationDuration(Chan::E ch, Value duration);

    static void SetManipulationPeriod(Chan::E ch, Value period);

    static void SetPacketPeriod(Chan::E ch, Value duration);

    static void SetPacketNumber(Chan::E ch, Value number);

    static void SetPeriod(Chan::E ch, Value period);
};


struct Attenuation
{
    enum E
    {
        _0Db,
        _10Db,
        _20Db,
        _30Db,
        Count
    } value;

    explicit Attenuation(Attenuation::E v) : value(v) { }
    float Units() const;
    pString Name() const;
};


class Amplifier
{
public:
    
    static void Init();
    
    // Настроить усилитель в соответствии с текущими настройками
    static void Tune(Chan::E ch);
    
    // Возвращает коэффициент усиления в разах всего тракта, включая аттенюатор и усилитель. Усилитель даёт усиление 10 раз, за каждые 10 Дб нужно разделить на 3.16
    static double GetAmplification(Chan::E ch);
    
    // Заблокировать переключение
    static void Block()   { isBlocked = true; };
    
    // Разблокировать переключение
    static void Unblock() { isBlocked = false; };
    
    // Возвращает true, если на данном канале включён усилитель
    static bool IsEnabled(Chan::E ch) { return isEnabled[ch]; }

    // Включить/выключить аппаратный усилитель усилитель
    static void Enable(Chan::E ch, bool enable);

private:
    
    static void SetAttenuation(Chan::E ch, Attenuation::E attenuation);

    static Attenuation::E attenuation[Chan::Count];
    
    // Установленное в true значение означает, что усилитель заблокирован - никакие действия в Tune() выолняться не будут
    static bool isBlocked;
    
    // true, если усилитель соотвествующего канала включён
    static bool isEnabled[Chan::Count];
};


struct SettingsGenerator
{
    friend class DGenerator;
public:
    // Возвращает установленную на канале амплитуду. Амплитуда возвращается без учёта аттёнюатора
    static double Amplitude(Chan::E ch)     { return amplitude[ch].ToDouble(); }
    static Value AmplitudeValue(Chan::E ch) { return amplitude[ch]; }
    // Возвращает установленное на канале смещение
    static double Offset(Chan::E ch)        { return offset[ch].ToDouble(); }
    static Value OffsetValue(Chan::E ch)    { return offset[ch]; }
    // Возвращает установленную частоту на канале
    static double Frequency(Chan::E ch) { return frequency[ch].ToDouble(); }
    // Возвращает true, если на канале ch установлена синусоидальная форма сигнала
    static bool FormIsSine(Chan::E ch) { return waveIsSine[ch]; }
private:
    // true, если на канале установлена форма сигнала "синусоида"
    static bool waveIsSine[Chan::Count];
    // Текущая установленная амплитуда на канале
    static Value amplitude[Chan::Count];
    // Текущая установленное смещение на кнаале
    static Value offset[Chan::Count];
    // Текущая частота на канале
    static Value frequency[Chan::Count];
};
